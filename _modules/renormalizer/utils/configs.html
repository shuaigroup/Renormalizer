<!doctype html>
<html class="no-js" lang="en">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-3HTENNM8CV"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-3HTENNM8CV');
    </script>
    <link rel="index" title="Index" href="../../../genindex.html" /><link rel="search" title="Search" href="../../../search.html" />

    <meta name="generator" content="sphinx-5.3.0, furo 2022.09.29"/>
        <title>renormalizer.utils.configs - Renormalizer 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo.css?digest=d81277517bee4d6b0349d71bb2661d4890b5617c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    
    


<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../../index.html"><div class="brand">Renormalizer 0.1.0 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../../index.html">
  
  
  <span class="sidebar-brand-text">Renormalizer 0.1.0 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../../search.html" role="search">
  <input class="sidebar-search" placeholder=Search name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation guide</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../tutorial.html">Basic Tutorials</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorials/define_model.html">Define Your Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorials/mps_mpo.html">MPS and MPO</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorials/nuclear_basis.html">Nuclear Basis Set</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorials/quantum_number.html">Quantum Numbers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorials/compress_mps.html">Compressing MPS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorials/ttn_basic.html">Basics of Tree Tensor Networks</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../applications.html">Application Tutorials</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorials/1D-Heisenberg.html">Ground state of the Heisenberg model</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../api.html">API Reference</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../model.html">Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../mps.html">Low Level Data Structure and Algorithms</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../static.html">Static Eigenstate Method</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../spectrum.html">spectra: absorption/emission spectrum at zero/finite temperature</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ct.html">Charge Transport</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../cv.html">Frequency domain DMRG</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../sbm.html">Spin-Boson Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ttn.html">Tree Tensor Network Algorithms</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../configs.html">Calculation Configurations</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develop.html">How to develop Renormalizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cite.html">How to cite</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <h1>Source code for renormalizer.utils.configs</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">renormalizer.utils.rk</span><span class="w"> </span><span class="kn">import</span> <span class="n">RungeKutta</span><span class="p">,</span> <span class="n">TaylorExpansion</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy.linalg</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="CompressCriteria"><a class="viewcode-back" href="../../../configs.html#renormalizer.utils.configs.CompressCriteria">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">CompressCriteria</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Criteria for compression.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#: Compress depending on pre-set threshold.</span>
    <span class="c1">#: States with singular value smaller than the threshold are discarded.</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="s2">&quot;threshold&quot;</span>
    <span class="c1">#: Compress depending on pre-set fixed bond dimension.</span>
    <span class="n">fixed</span> <span class="o">=</span> <span class="s2">&quot;fixed&quot;</span>
    <span class="c1">#: Compress combining ``threshold`` and ``fixed``. The bond dimension for the two criteria are both</span>
    <span class="c1">#: calculated and the smaller one is used.</span>
    <span class="n">both</span> <span class="o">=</span> <span class="s2">&quot;both&quot;</span></div>


<div class="viewcode-block" id="OFS"><a class="viewcode-back" href="../../../configs.html#renormalizer.utils.configs.OFS">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">OFS</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    On the fly swapping criteria</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># based on entanglement entropy</span>
    <span class="n">ofs_s</span> <span class="o">=</span> <span class="s2">&quot;OFS-S&quot;</span>
    <span class="c1"># a hybrid scheme</span>
    <span class="n">ofs_ds</span> <span class="o">=</span> <span class="s2">&quot;OFS-D/S&quot;</span>
    <span class="c1"># based on discarded weight</span>
    <span class="n">ofs_d</span> <span class="o">=</span> <span class="s2">&quot;OFS-D&quot;</span>
    <span class="c1"># debug mode. Dry run the code without performing the swapping</span>
    <span class="n">ofs_debug</span> <span class="o">=</span> <span class="s2">&quot;OFS-Debug&quot;</span></div>


<div class="viewcode-block" id="CompressConfig"><a class="viewcode-back" href="../../../configs.html#renormalizer.utils.configs.CompressConfig">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">CompressConfig</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;MPS/MPO Compress Configuration.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    criteria : `CompressCriteria`, optional</span>
<span class="sd">        The criteria for compression. Default is</span>
<span class="sd">        `CompressCriteria.threshold`.</span>
<span class="sd">    threshold : float, optional</span>
<span class="sd">        The threshold to keep states if ``criteria`` is set to</span>
<span class="sd">        `CompressCriteria.threshold` or `CompressCriteria.both`.</span>
<span class="sd">        Default is :math:`10^{-3}`.</span>
<span class="sd">    max_bonddim : int, optional</span>
<span class="sd">        Maximum bond dimension ``M`` under various bond dimension distributions.</span>
<span class="sd">        Default is 32.</span>
<span class="sd">    vmethod : str, optional</span>
<span class="sd">        The algorithm used in variational compression. The default is ``2site``.</span>

<span class="sd">        - ``1site``:  optimize one site at a time during sweep.</span>
<span class="sd">        - ``2site``:  optimize two site at a time during sweep.</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        It is recommended to use the 2site algorithm in variational optimization,</span>
<span class="sd">        though 1site algorithm is much cheaper. The reason is that 1site algorithm</span>
<span class="sd">        is easy to stuck into local minima while 2site algorithm is more robust. For</span>
<span class="sd">        complicated Hamiltonian, the problem is severer.  The renormalized basis</span>
<span class="sd">        selection rule used here to partly solve the local minimal problem is</span>
<span class="sd">        according to Chan. J.  Chem. Phys. 2004, 120, 3172. For efficiency, you</span>
<span class="sd">        could use 2site algorithm for several sweeps and then switch to 1site</span>
<span class="sd">        algorithm to converge the final mps.</span>

<span class="sd">    vprocedure : list, optional</span>
<span class="sd">        The procedure to do variational compression. In the sublist, the first</span>
<span class="sd">        element is a CompressConfig, which controls the compression in each</span>
<span class="sd">        sweep. For backward compatibility, it can also be an int, which indicates</span>
<span class="sd">        CompressCriteria.fixed with the int as the max_bonddim.</span>
<span class="sd">        The Default is</span>

<span class="sd">        .. code-block::</span>

<span class="sd">            if vmethod == &quot;1site&quot;:</span>
<span class="sd">                vprocedure = [[max_bonddim,1.0],[max_bonddim,0.7],</span>
<span class="sd">                              [max_bonddim,0.5],[max_bonddim,0.3],</span>
<span class="sd">                              [max_bonddim,0.1]] + [[max_bonddim,0],]*10</span>
<span class="sd">            else:</span>
<span class="sd">                vprocedure = [[max_bonddim,0.5],[max_bonddim,0.3],</span>
<span class="sd">                              [max_bonddim,0.1]] + [[max_bonddim,0],]*10</span>

<span class="sd">    vrtol : float, optional</span>
<span class="sd">        The threshold of convergence in variational compression. Default is</span>
<span class="sd">        :math:`10^{-5}`.</span>
<span class="sd">    vguess_m : tuple(int), optional</span>
<span class="sd">        The bond dimension of ``compressed_mpo`` and ``compressed_mps`` to construct the initial guess</span>
<span class="sd">        ``compressed_mpo @ compressed_mps`` in `MatrixProduct.variational_compress`.</span>
<span class="sd">        The default is (5,5).</span>
<span class="sd">    dump_matrix_size : int or float, optional</span>
<span class="sd">        The total bytes threshold for dumping matrix into disks. Every local site matrix in the MPS/MPO</span>
<span class="sd">        with a size larger than the specified size will be moved from memory to the disk at ``dump_matrix_dir``.</span>
<span class="sd">        The matrix will be moved back to memory upon access.</span>
<span class="sd">        The dumped matrices on the disks will be removed once the MPS/MPO is garbage-collected.</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        If ``dump_matrix_size`` is set and the program exits abnormally, it is possible that the dumped matrices</span>
<span class="sd">        are not deleted automatically. A common case when this can happen is that the program is killed by a signal.</span>
<span class="sd">        In such cases it is recommended to check and clean ``dump_matrix_dir`` after the exit of the program</span>
<span class="sd">        since the dumped matrices may take a lot of disk space.</span>

<span class="sd">    dump_matrix_dir : str, optional</span>
<span class="sd">        The directory to dump matrix when matrix is larger than ``dump_matrix_size``.</span>

<span class="sd">    ofs : `OFS`, optional</span>
<span class="sd">        Whether optimize the DOF ordering by OFS. The default value is ``None`` which means does not perform OFS.</span>

<span class="sd">    ofs_swap_jw : bool, optional</span>
<span class="sd">        Whether swap the Jordan-Wigner transformation ordering when OFS is enabled. Set to ``True``</span>
<span class="sd">        for and only for ab initio Hamiltonian constructed by the experimental</span>
<span class="sd">        ``renormalizer.model.h_qc.qc_model``. Default is ``False``.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    CompressCriteria : Compression criteria</span>
<span class="sd">    renormalizer.mps.mp.MatrixProduct.variational_compress : Variational compression</span>
<span class="sd">    renormalizer.mps.Mpo.contract : compress ``mpo @ mps/mpdm/mpo``</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">criteria</span><span class="p">:</span> <span class="n">CompressCriteria</span> <span class="o">=</span> <span class="n">CompressCriteria</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span>
        <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span>
        <span class="n">max_bonddim</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
        <span class="n">vmethod</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;2site&quot;</span><span class="p">,</span>
        <span class="n">vprocedure</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">vrtol</span> <span class="o">=</span> <span class="mf">1e-5</span><span class="p">,</span>
        <span class="n">vguess_m</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span>
        <span class="n">dump_matrix_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
        <span class="n">dump_matrix_dir</span> <span class="o">=</span> <span class="s2">&quot;./&quot;</span><span class="p">,</span>
        <span class="n">ofs</span><span class="p">:</span> <span class="n">OFS</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ofs_swap_jw</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">):</span>
        <span class="c1"># two sets of criteria here: threshold and max_bonddimension</span>
        <span class="c1"># `criteria` is to determine which to use</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">:</span> <span class="n">CompressCriteria</span> <span class="o">=</span> <span class="n">criteria</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_threshold</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bond_dim_max_value</span> <span class="o">=</span> <span class="n">max_bonddim</span>
        <span class="c1"># the length should be len(mps) + 1, the terminals are also counted. This is for accordance with mps.bond_dims</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_dims</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_dims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bond_dim_max_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_dims</span><span class="p">)</span>

        <span class="c1"># variational compression parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vmethod</span> <span class="o">=</span> <span class="n">vmethod</span>
        <span class="k">if</span> <span class="n">vprocedure</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">vmethod</span> <span class="o">==</span> <span class="s2">&quot;1site&quot;</span><span class="p">:</span>
                <span class="n">vprocedure</span> <span class="o">=</span> <span class="p">[[</span><span class="n">max_bonddim</span><span class="p">,</span><span class="mf">1.0</span><span class="p">],[</span><span class="n">max_bonddim</span><span class="p">,</span><span class="mf">0.7</span><span class="p">],</span>
                              <span class="p">[</span><span class="n">max_bonddim</span><span class="p">,</span><span class="mf">0.5</span><span class="p">],[</span><span class="n">max_bonddim</span><span class="p">,</span><span class="mf">0.3</span><span class="p">],</span>
                              <span class="p">[</span><span class="n">max_bonddim</span><span class="p">,</span><span class="mf">0.1</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[[</span><span class="n">max_bonddim</span><span class="p">,</span><span class="mi">0</span><span class="p">],]</span><span class="o">*</span><span class="mi">10</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vprocedure</span> <span class="o">=</span> <span class="p">[[</span><span class="n">max_bonddim</span><span class="p">,</span><span class="mf">0.5</span><span class="p">],[</span><span class="n">max_bonddim</span><span class="p">,</span><span class="mf">0.3</span><span class="p">],</span>
                              <span class="p">[</span><span class="n">max_bonddim</span><span class="p">,</span><span class="mf">0.1</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[[</span><span class="n">max_bonddim</span><span class="p">,</span><span class="mi">0</span><span class="p">],]</span><span class="o">*</span><span class="mi">10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vprocedure</span> <span class="o">=</span> <span class="n">vprocedure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vrtol</span> <span class="o">=</span> <span class="n">vrtol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vguess_m</span> <span class="o">=</span> <span class="n">vguess_m</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dump_matrix_size</span> <span class="o">=</span> <span class="n">dump_matrix_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dump_matrix_dir</span> <span class="o">=</span> <span class="n">dump_matrix_dir</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ofs</span><span class="p">:</span> <span class="n">OFS</span> <span class="o">=</span> <span class="n">ofs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ofs_swap_jw</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">ofs_swap_jw</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_threshold</span>

    <span class="nd">@threshold</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;non-positive threshold&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">v</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;1 is an ambiguous threshold&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">v</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t set threshold to be larger than 1&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_threshold</span> <span class="o">=</span> <span class="n">v</span>

<div class="viewcode-block" id="CompressConfig.set_bonddim"><a class="viewcode-back" href="../../../configs.html#renormalizer.utils.configs.CompressConfig.set_bonddim">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_bonddim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">length</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_dims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_dims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bond_dim_max_value</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_threshold_m_trunc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sigma</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">&lt;</span> <span class="mi">1</span>
        <span class="c1"># count how many sing vals &lt; trunc</span>
        <span class="n">normed_sigma</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">/</span> <span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">normed_sigma</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_fixed_m_trunc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sigma</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">left</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_dims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">bond_idx</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">left</span> <span class="k">else</span> <span class="n">idx</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_dims</span><span class="p">[</span><span class="n">bond_idx</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>

<div class="viewcode-block" id="CompressConfig.compute_m_trunc"><a class="viewcode-back" href="../../../configs.html#renormalizer.utils.configs.CompressConfig.compute_m_trunc">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_m_trunc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sigma</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">left</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span> <span class="ow">is</span> <span class="n">CompressCriteria</span><span class="o">.</span><span class="n">threshold</span><span class="p">:</span>
            <span class="n">trunc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_threshold_m_trunc</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span> <span class="ow">is</span> <span class="n">CompressCriteria</span><span class="o">.</span><span class="n">fixed</span><span class="p">:</span>
            <span class="n">trunc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixed_m_trunc</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">left</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span> <span class="ow">is</span> <span class="n">CompressCriteria</span><span class="o">.</span><span class="n">both</span><span class="p">:</span>
            <span class="c1"># use the smaller one</span>
            <span class="n">trunc</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_threshold_m_trunc</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixed_m_trunc</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">left</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">trunc</span></div>

<div class="viewcode-block" id="CompressConfig.update"><a class="viewcode-back" href="../../../configs.html#renormalizer.utils.configs.CompressConfig.update">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s2">&quot;CompressConfig&quot;</span><span class="p">):</span>
        <span class="c1"># use the stricter of the two</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">criteria</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t update configs with different standard&quot;</span><span class="p">)</span>
        <span class="c1"># look for minimum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">threshold</span><span class="p">)</span>
        <span class="c1"># look for maximum</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_dims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_dims</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">max_dims</span>
        <span class="k">elif</span> <span class="n">other</span><span class="o">.</span><span class="n">max_dims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># do nothing</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_dims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_dims</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">max_dims</span><span class="p">)</span></div>

<div class="viewcode-block" id="CompressConfig.relax"><a class="viewcode-back" href="../../../configs.html#renormalizer.utils.configs.CompressConfig.relax">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">relax</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># relax the two criteria simultaneously</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="mf">0.9</span>
        <span class="p">)</span>  <span class="c1"># can&#39;t set to 1 which is ambiguous</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_dims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_dims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_dims</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_dims</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="CompressConfig.copy"><a class="viewcode-back" href="../../../configs.html#renormalizer.utils.configs.CompressConfig.copy">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CompressConfig&quot;</span><span class="p">:</span>
        <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
        <span class="c1"># shallow copies</span>
        <span class="n">new</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># deep copies</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_dims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new</span><span class="o">.</span><span class="n">max_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_dims</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">new</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">bonddim_should_set</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">CompressCriteria</span><span class="o">.</span><span class="n">threshold</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_dims</span> <span class="ow">is</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;criteria&quot;</span><span class="p">,</span> <span class="s2">&quot;threshold&quot;</span><span class="p">]</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="n">attr_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">attr_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>


<div class="viewcode-block" id="OptimizeConfig"><a class="viewcode-back" href="../../../configs.html#renormalizer.utils.configs.OptimizeConfig">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">OptimizeConfig</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot; DMRG ground state algorithm optimization configuration</span>

<span class="sd">        The procedure to do ground state optimization. In the sublist, the first</span>
<span class="sd">        element is a CompressConfig, which controls the compression in each</span>
<span class="sd">        sweep. For backward compatibility, it can also be an int, which indicates</span>
<span class="sd">        CompressCriteria.fixed with the int as the max_bonddim.</span>
<span class="sd">        The second element is the percent to choose the renormalied basis from</span>
<span class="sd">        each symmetry block to avoid trapping into local minimum.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">procedure</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">procedure</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">procedure</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">10</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">],</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span> <span class="p">[</span><span class="mi">30</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span> <span class="p">[</span><span class="mi">40</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">40</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">procedure</span> <span class="o">=</span> <span class="n">procedure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;2site&quot;</span>
        <span class="c1"># algo: arpack(Implicitly Restarted Lanczos Method)</span>
        <span class="c1">#       davidson(pyscf/davidson)</span>
        <span class="c1">#       primme (if installed)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">algo</span> <span class="o">=</span> <span class="s2">&quot;davidson&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nroots</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># the ground state energy convergence tolerance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e_rtol</span> <span class="o">=</span> <span class="mf">1e-6</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e_atol</span> <span class="o">=</span> <span class="mf">1e-8</span>
        <span class="c1"># inverse = 1.0 or -1.0</span>
        <span class="c1"># -1.0 to get the largest eigenvalue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inverse</span> <span class="o">=</span> <span class="mf">1.0</span>

<div class="viewcode-block" id="OptimizeConfig.copy"><a class="viewcode-back" href="../../../configs.html#renormalizer.utils.configs.OptimizeConfig.copy">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
        <span class="n">new</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">new</span><span class="o">.</span><span class="n">procedure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">procedure</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">new</span></div></div>

<div class="viewcode-block" id="EvolveMethod"><a class="viewcode-back" href="../../../configs.html#renormalizer.utils.configs.EvolveMethod">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">EvolveMethod</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Time evolution methods.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># propagation and compression with RK45 propagator and time independent H</span>
    <span class="n">prop_and_compress</span> <span class="o">=</span> <span class="s2">&quot;P&amp;C&quot;</span>
    <span class="c1"># propagation and compression with RK4 propagator and time dependent/independent H</span>
    <span class="n">prop_and_compress_tdrk4</span> <span class="o">=</span> <span class="s2">&quot;P&amp;C TD RK4&quot;</span>
    <span class="c1"># propagation and compression with RK propagator and time dependent/independent H</span>
    <span class="n">prop_and_compress_tdrk</span> <span class="o">=</span> <span class="s2">&quot;P&amp;C TD RK&quot;</span>
    <span class="c1"># TDVP with projector splitting - one site</span>
    <span class="n">tdvp_ps</span> <span class="o">=</span> <span class="s2">&quot;TDVP PS one-site&quot;</span>
    <span class="c1"># TDVP with projector splitting - two site</span>
    <span class="n">tdvp_ps2</span> <span class="o">=</span> <span class="s2">&quot;TDVP PS two-site&quot;</span>
    <span class="c1"># TDVP with variable mean field (VMF)</span>
    <span class="n">tdvp_vmf</span> <span class="o">=</span> <span class="s2">&quot;TDVP Variable Mean Field&quot;</span>
    <span class="c1"># TDVP with constant mean field (CMF) and matrix unfolding (MU) regularization</span>
    <span class="n">tdvp_mu_cmf</span> <span class="o">=</span> <span class="s2">&quot;TDVP Matrix Unfolding Constant Mean Field&quot;</span>
    <span class="c1"># TDVP with variable mean field (VMF) and matrix unfolding (MU) regularization</span>
    <span class="n">tdvp_mu_vmf</span> <span class="o">=</span> <span class="s2">&quot;TDVP Matrix Unfolding Variable Mean Field&quot;</span></div>


<div class="viewcode-block" id="parse_memory_limit"><a class="viewcode-back" href="../../../configs.html#renormalizer.utils.configs.parse_memory_limit">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">parse_memory_limit</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">x_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">num</span><span class="p">,</span> <span class="n">unit</span> <span class="o">=</span> <span class="n">x_str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">unit</span> <span class="o">=</span> <span class="n">unit</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;kb&quot;</span><span class="p">:</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;mb&quot;</span><span class="p">:</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;gb&quot;</span><span class="p">:</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">30</span><span class="p">}</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="o">*</span> <span class="n">mapping</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="c1"># might error when converting to str, but the message is clear enough.</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid input for memory: </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="EvolveConfig"><a class="viewcode-back" href="../../../configs.html#renormalizer.utils.configs.EvolveConfig">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">EvolveConfig</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">method</span><span class="p">:</span> <span class="n">EvolveMethod</span> <span class="o">=</span> <span class="n">EvolveMethod</span><span class="o">.</span><span class="n">prop_and_compress</span><span class="p">,</span>
        <span class="n">adaptive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">guess_dt</span><span class="o">=</span><span class="mf">1e-1</span><span class="p">,</span>
        <span class="n">adaptive_rtol</span><span class="o">=</span><span class="mf">5e-4</span><span class="p">,</span>
        <span class="n">taylor_order</span><span class="p">:</span><span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">rk_solver</span><span class="o">=</span><span class="s2">&quot;C_RK4&quot;</span><span class="p">,</span>
        <span class="n">reg_epsilon</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span>
        <span class="n">ivp_rtol</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span>
        <span class="n">ivp_atol</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span>
        <span class="n">ivp_solver</span><span class="o">=</span><span class="s2">&quot;krylov&quot;</span><span class="p">,</span>
        <span class="n">force_ovlp</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adaptive</span> <span class="o">=</span> <span class="n">adaptive</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rk_config</span> <span class="o">=</span> <span class="n">RungeKutta</span><span class="p">(</span><span class="n">rk_solver</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">taylor_order</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">adaptive</span><span class="p">:</span>
                <span class="n">taylor_order</span> <span class="o">=</span> <span class="mi">5</span>  
            <span class="k">else</span><span class="p">:</span>
                <span class="n">taylor_order</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taylor_config</span> <span class="o">=</span> <span class="n">TaylorExpansion</span><span class="p">(</span><span class="n">taylor_order</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">guess_dt</span><span class="p">:</span> <span class="nb">complex</span> <span class="o">=</span> <span class="n">guess_dt</span>  <span class="c1"># a guess of initial adaptive time step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adaptive_rtol</span> <span class="o">=</span> <span class="n">adaptive_rtol</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tdvp_cmf_midpoint</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tdvp_cmf_c_trapz</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># regularization parameter in tdvp_mu or tdvp_std method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reg_epsilon</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">reg_epsilon</span>
        <span class="c1"># scipy.ivp rtol and atol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ivp_rtol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">ivp_rtol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ivp_atol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">ivp_atol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ivp_solver</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">ivp_solver</span>
        <span class="c1"># the EOM has already considered the non-orthogonality of the left and right</span>
        <span class="c1"># renormalized basis, see arXiv:1907.12044</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">force_ovlp</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">force_ovlp</span>
        <span class="c1"># auto switch between mu_vmf and vmf for a higher efficiency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vmf_auto_switch</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_tdvp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">EvolveMethod</span><span class="o">.</span><span class="n">prop_and_compress</span><span class="p">,</span>
                <span class="n">EvolveMethod</span><span class="o">.</span><span class="n">prop_and_compress_tdrk4</span><span class="p">,</span>
                <span class="n">EvolveMethod</span><span class="o">.</span><span class="n">prop_and_compress_tdrk</span><span class="p">]</span>

<div class="viewcode-block" id="EvolveConfig.check_valid_dt"><a class="viewcode-back" href="../../../configs.html#renormalizer.utils.configs.EvolveConfig.check_valid_dt">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">check_valid_dt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evolve_dt</span><span class="p">:</span> <span class="nb">complex</span><span class="p">):</span>
        <span class="n">info_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;in config: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">guess_dt</span><span class="si">}</span><span class="s2">, in arg: </span><span class="si">{</span><span class="n">evolve_dt</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">iscomplex</span><span class="p">(</span><span class="n">evolve_dt</span><span class="p">)</span> <span class="o">^</span> <span class="n">np</span><span class="o">.</span><span class="n">iscomplex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">guess_dt</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;real and imag not compatible. &quot;</span> <span class="o">+</span> <span class="n">info_str</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">iscomplex</span><span class="p">(</span><span class="n">evolve_dt</span><span class="p">)</span> <span class="ow">and</span> <span class="n">evolve_dt</span><span class="o">.</span><span class="n">imag</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">guess_dt</span><span class="o">.</span><span class="n">imag</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> \
                <span class="p">(</span><span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">iscomplex</span><span class="p">(</span><span class="n">evolve_dt</span><span class="p">)</span> <span class="ow">and</span> <span class="n">evolve_dt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">guess_dt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;evolve into wrong direction. &quot;</span> <span class="o">+</span> <span class="n">info_str</span><span class="p">)</span></div>


<div class="viewcode-block" id="EvolveConfig.copy"><a class="viewcode-back" href="../../../configs.html#renormalizer.utils.configs.EvolveConfig.copy">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
        <span class="n">new</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">new</span></div>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="n">attr_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">attr_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>
</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2024, Shuaigroup
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/scripts/furo.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    </body>
</html>